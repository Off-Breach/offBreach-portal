<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!----======== CSS ======== -->
    <link rel="stylesheet" href="../CSS/style.css" />
    <link rel="stylesheet" href="../CSS/grafico_style.css" />
    <link rel="stylesheet" href="../CSS/navbar_style.css" />

    <!----===== Boxicons CSS ===== -->
    <link
      href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css"
      rel="stylesheet"
    />

    <title>Dashboard Sidebar Menu</title>
  </head>

  <body>
    <nav class="sidebar">
      <header>
        <div class="image-text">
          <span class="image">
            <img src="../../assets/img/Logos/OFFBREACH.icon.png" alt="" />
          </span>

          <div class="text logo-text">
            <span class="name">Bem Vindo</span>
            <span class="profession">User</span>
          </div>
        </div>
      </header>

      <div class="menu-bar">
        <div class="menu">
          <ul class="menu-links">
            <li class="nav-link">
              <a href="inicio.html">
                <i class="bx bx-home-alt icon"></i>
                <span class="text nav-text">Início</span>
              </a>
            </li>

            <li class="nav-link">
              <a href="graficos.html">
                <i class="bx bx-bar-chart-alt-2 icon"></i>
                <span class="text nav-text">Gráficos</span>
              </a>
            </li>

            <li class="nav-link">
              <a href="cadastros.html">
                <i class="bx bx-user icon"></i>
                <span class="text nav-text">Usuários</span>
              </a>
            </li>

            <li class="nav-link">
              <a href="servidores.html">
                <i class="bx bx-server icon"></i>
                <span class="text nav-text">Servidores</span>
              </a>
            </li>

            <li class="nav-link">
              <a href="alerta.html">
                <i class="bx bx-error icon"></i>
                <span class="text nav-text">Alertas</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="bottom-content">
          <li class="">
            <a href="#">
              <i class="bx bx-log-out icon"></i>
              <span class="text nav-text">Sair</span>
            </a>
          </li>

          <li class="mode">
            <div class="sun-moon">
              <i class="bx bx-moon icon moon"></i>
              <i class="bx bx-sun icon sun"></i>
            </div>
            <span class="mode-text text">Dark mode</span>

            <div class="toggle-switch">
              <span class="switch"></span>
            </div>
          </li>
        </div>
      </div>
    </nav>

    <div id="grafico">
      <p id="titulo_grafico" class="titulo_grafico">Estado dos componentes</p>
      <div class="Grafico1">
        <canvas id="meuGrafico1"></canvas>
      </div>
    </div>

    <div id="kpi">
      <div id="donut">
        <canvas id="meuGrafico2"> </canvas>
        <canvas id="meuGrafico3"> </canvas>
        <canvas id="meuGrafico4"> </canvas>
      </div>

      <div id="alerts_analytics">
        <div id="alerta1">
          <img src="./../../assets/img/Imagens/verde.png" />
        </div>

        <div id="alerta2">
          <img src="./../../assets/img/Imagens/marelo.png" />
        </div>

        <div id="alerta3">
          <img src="./../../assets/img/Imagens/vermelhor.png" />
        </div>
      </div>
      <p id="txta_cpu">CPU</p>
      <p id="txta_ram">RAM</p>
      <p id="txta_disco">DISCO</p>
    </div>

    <div id="servidor"></div>
  </body>
</html>
<script src="../JS/script.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let proximaAtualizacao;
  window.onload = obterTodosServidoresClinica(
    localStorage.getItem("ID_CLINICA")
  );

  function obterTodosServidoresClinica(idClinica) {
    fetch(`/medidas/servidores/${idClinica}`, { cache: "no-store" })
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Servidores recebidos: ${JSON.stringify(resposta)}`);
            let divBotoesServidor = document.getElementById("servidor");
            let tituloGrafico = document.getElementById("titulo_grafico");
            for (let i = 0; i < resposta.length; i++) {
              const servidor = resposta[i];
              divBotoesServidor.innerHTML += `<button class="button-28" role="button" onclick="obterDadosServidor(${servidor.idServidor}), document.getElementById('titulo_grafico').innerHTML = 'Estado dos componentes - Servidor ${servidor.hostName}'">Servidor ${servidor.hostName}</button>`;
            }
            tituloGrafico.innerHTML =
              "Estado do Servidor - " + resposta[0].hostName;
            obterDadosServidor(resposta[0].idServidor);
          });
        } else {
        }
      })
      .catch();
  }

  function obterDadosServidor(idServidor) {
    if (proximaAtualizacao != undefined) {
      clearTimeout(proximaAtualizacao);
    }

    fetch(`/medidas/ultimas/${idServidor}`, { cache: "no-store" })
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

            plotarGrafico(resposta, idServidor);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }

  // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // Configura o gráfico (cores, tipo, etc), materializa-o na página e,
  // A função *plotarGrafico* também invoca a função *atualizarGrafico*
  function plotarGrafico(resposta, idServidor) {
    console.log("iniciando plotagem do gráfico...");

    const labelsGraficoLinha = [];

    let dados = {
      labels: labelsGraficoLinha,
      datasets: [
        {
          label: "CPU",
          backgroundColor: "#09506f",
          borderColor: "#09506f",
          data: [],
        },
        {
          label: "RAM",
          backgroundColor: "#2c7899",
          borderColor: "#2c7899",
          data: [],
        },
        {
          label: "Disco",
          backgroundColor: "#62b6d3",
          borderColor: "#62b6d3",
          data: [],
        },
      ],
    };

    for (i = 0; i < resposta.length; i++) {
      const hardware = resposta[i];
      hardware.reverse();
      for (let j = 0; j < hardware.length; j++) {
        const registro = hardware[j];
        if (i == 0) {
          labelsGraficoLinha.push(convertTZ(registro.dtDado));
        }
        dados.datasets[i].data.push(registro.uso);
      }
    }
    const dadosCpu = resposta[0];
    const dadosRam = resposta[1];
    const dadosDisco = resposta[2];

    let dadosGraficoCpu = {
      labels: ["Uso da Cpu", ""],
      datasets: [
        {
          label: "",
          data: [
            dadosCpu[dadosCpu.length - 1].uso,
            100 - dadosCpu[dadosCpu.length - 1].uso,
          ],
          backgroundColor: ["rgb(255, 99, 132)", "rgba(54, 162, 235, 0)"],
          borderWidth: [2, 0],
          hoverOffset: 4,
        },
      ],
    };
    let dadosGraficoRam = {
      labels: ["Uso da Ram", ""],
      datasets: [
        {
          label: "",
          data: [
            dadosRam[dadosRam.length - 1].uso,
            100 - dadosRam[dadosRam.length - 1].uso,
          ],
          backgroundColor: ["rgb(255,99,132)", "rgba(54, 162, 235, 0)"],
          borderWidth: [2, 0],
          hoverOffset: 4,
        },
      ],
    };
    let dadosGraficoDisco = {
      labels: ["Uso do Disco", ""],
      datasets: [
        {
          label: "",
          data: [
            dadosDisco[dadosDisco.length - 1].uso,
            100 - dadosDisco[dadosDisco.length - 1].uso,
          ],
          backgroundColor: ["rgb(255,99,132)", "rgba(54, 162, 235, 0)"],
          borderWidth: [2, 0],
          hoverOffset: 4,
        },
      ],
    };

    const configGraficoCpu = {
      type: "doughnut",
      data: dadosGraficoCpu,
      options: {
        cutout: 50,
        layout: {
          padding: 0,
        },
        plugins: {
          legend: {
            labels: {
              color: "white",
              font: {
                size: 20
              }
            }
          }
        }
      },
    };

    const configGraficoRam = {
      type: "doughnut",
      data: dadosGraficoRam,
      options: {
        cutout: 50,
        layout: {
          padding: 0,
        },
        plugins: {
          legend: {
            labels: {
              color: "white",
              font: {
                size: 20
              }
            }
          }
        }
      },
    };

    const configGraficoDisco = {
      type: "doughnut",
      data: dadosGraficoDisco,
      options: {
        cutout: 50,
        layout: {
          padding: 0,
        },
        plugins: {
          legend: {
            labels: {
              color: "white",
              font: {
                size: 20
              }
            }
          }
        }
      },
    };

    const configGraficoLinhas = {
      type: "line",
      data: dados,
      options: {
        responsive: true,
        scales: {
          y: {
            max: 100.0,
            min: 0.0,
          },
        },
      },
    };
    let meuGraficoStatus = [
      Chart.getChart("meuGrafico1"),
      Chart.getChart("meuGrafico2"),
      Chart.getChart("meuGrafico3"),
      Chart.getChart("meuGrafico4"),
    ];
    for (let i = 0; i < meuGraficoStatus.length; i++) {
      const grafico = meuGraficoStatus[i];
      if (grafico != undefined) {
        grafico.destroy();
      }
    }

    let meuGrafico1 = new Chart(
      document.getElementById("meuGrafico1"),
      configGraficoLinhas
    );
    let meuGrafico2 = new Chart(
      document.getElementById("meuGrafico2"),
      configGraficoCpu
    );
    let meuGrafico3 = new Chart(
      document.getElementById("meuGrafico3"),
      configGraficoRam
    );
    let meuGrafico4 = new Chart(
      document.getElementById("meuGrafico4"),
      configGraficoDisco
    );

    console.log("Chegou aqui");

    setTimeout(() => {
      atualizarGrafico(
        idServidor,
        dados,
        [dadosGraficoCpu, dadosGraficoRam, dadosGraficoDisco],
        meuGrafico1,
        [meuGrafico2, meuGrafico3, meuGrafico4]
      );
    }, 10000);
  }

  // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
  // buscando a última medida inserida em tabela contendo as capturas,

  // Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  // Para ajustar o "select", ajuste o comando sql em src/models
  function atualizarGrafico(
    idServidor,
    dadosGraficoLinha,
    dadosGraficosRosca,
    graficoLinha,
    graficosRosca
  ) {
    fetch(`/medidas/tempoReal/${idServidor}`, { cache: "no-store" })
      .then(function (response) {
        if (response.ok) {
          console.log("Aqui?");
          console.log(response);
          response.json().then(function (novoRegistro) {
            console.log("Ou aqui");
            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico:`);
            console.log(dadosGraficoLinha);

            if (
              convertTZ(novoRegistro[0].dtDado) ==
              dadosGraficoLinha.labels[dadosGraficoLinha.labels.length - 1]
            ) {
              console.log(
                "---------------------------------------------------------------"
              );
              console.log(
                "Como não há dados novos para captura, o gráfico não atualizará."
              );
              console.log("Horário do novo dado capturado:");
              console.log(novoRegistro[0].dtDado);
              console.log("Horário do último dado capturado:");
              console.log(
                dadosGraficoLinha.labels[dadosGraficoLinha.labels.length - 1]
              );
              console.log(
                "---------------------------------------------------------------"
              );
            } else {
              // tirando e colocando valores no gráfico
              dadosGraficoLinha.labels.shift();
              dadosGraficoLinha.labels.push(convertTZ(novoRegistro[0].dtDado));
              dadosGraficoLinha.datasets[0].data.shift();
              dadosGraficoLinha.datasets[0].data.push(novoRegistro[0].usoCpu);
              dadosGraficoLinha.datasets[1].data.shift();
              dadosGraficoLinha.datasets[1].data.push(novoRegistro[0].usoRam);
              dadosGraficoLinha.datasets[2].data.shift();
              dadosGraficoLinha.datasets[2].data.push(novoRegistro[0].usoDisco);
              dadosGraficosRosca[0].datasets[0].data[0] =
                novoRegistro[0].usoCpu;
              dadosGraficosRosca[1].datasets[0].data[0] =
                novoRegistro[0].usoRam;
              dadosGraficosRosca[2].datasets[0].data[0] =
                novoRegistro[0].usoDisco;

              graficoLinha.update();
              graficosRosca[0].update();
              graficosRosca[1].update();
              graficosRosca[2].update();
            }

            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(
              () =>
                atualizarGrafico(
                  idServidor,
                  dadosGraficoLinha,
                  dadosGraficosRosca,
                  graficoLinha,
                  graficosRosca
                ),
              3000
            );
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(
            () =>
              atualizarGrafico(
                idServidor,
                dadosGraficoLinha,
                graficoLinha,
                graficosRosca
              ),
            3000
          );
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }
</script>
